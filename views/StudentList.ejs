<!DOCTYPE html>
<!-- 
Template Name: Mintos - Responsive Bootstrap 4 Admin Dashboard Template
Author: Hencework
Contact: https://hencework.ticksy.com/

License: You must have a valid license purchased only from templatemonster to legally use the template for your project.
-->
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Mintos - SHARED ON THEMELOCK.COM  I Data Table</title>
    <meta name="description" content="A responsive bootstrap 4 admin dashboard template by hencework" />

    <!-- Favicon -->
    <link rel="shortcut icon" href="favicon.ico">
    <link rel="icon" href="favicon.ico" type="image/x-icon">

    

</head>

<body>
    
   
	<!-- HK Wrapper -->
	

        

        

        <!-- Main Content -->
        <% layout('layout') %>
            <!-- Breadcrumb -->
            <nav class="hk-breadcrumb" aria-label="breadcrumb">
                <ol class="breadcrumb breadcrumb-light bg-transparent">
                    <li class="breadcrumb-item"><a href="#">Tables</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Students List</li>
                </ol>
            </nav>
            <!-- /Breadcrumb -->

            <!-- Container -->
            <div class="container">

                <!-- Title -->
                <div class="hk-pg-header">
                    <h4 class="hk-pg-title"><span class="pg-title-icon"><span class="feather-icon"><i data-feather="database"></i></span></span>Data Tables</h4>
                </div>
                <!-- /Title -->

                <!-- Row -->
                
                
                    

                <div class="row">
                    <div class="col-xl-12">
                        <section class="hk-sec-wrapper">
                            <h5 class="hk-sec-title" style="margin-bottom: 20px;">Students List</h5>
                            
                            <!-- <a href="/addStudent"  class="focus:outline-none text-white bg-purple-700 hover:bg-purple-800 focus:ring-4 focus:ring-purple-300 font-medium rounded-lg text-sm px-5 py-2.5 mb-2 dark:bg-purple-600 dark:hover:bg-purple-700 dark:focus:ring-purple-900" style="margin-left: 20px;">Add new Student</a> -->
                            <!-- Your button to open the modal -->
                            <button type="button" id="openAddStudentFormBtn" class="btn btn-primary">Add New Student</button>

                            <!-- The form to add a new student (initially hidden) -->
                            <div id="addStudentFormContainer" style="display: none; margin-top: 20px; margin-bottom: 20px;">
                                <form id="addStudentForm" method="post">
                                    <div class="form-group">
                                        <label for="cin">Your Card Id</label>
                                        <div class="input-group">
                                            
                                            <input class="form-control" id="cin" name="cin" type="number" pattern="[0,9]{8,0}" required>
                                        </div>
                                    </div>
                                    <p style="color: red; font-weight: bold;" id="message2"></p>
                                        

                                    <div class="form-group">
                                        <label for="name">Name</label>
                                        <div class="input-group">
                                            
                                            <input class="form-control" id="name" name="name" type="text" required>
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <label for="lastname">Last name</label>
                                        <input class="form-control" id="lastname" name="lastname"  type="text" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="age">Age</label>
                                        <input class="form-control" id="age" name="age"  type="number" required>
                                    </div>

                                    <div class="form-group">
                                        <label for="level">Level</label>
                                        <input class="form-control" id="level" name="level" type="text" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="classe">Class</label>
                                        <select class="form-control" id="classe" name="classe">
                                            
                                        </select>
                                    </div>

                                    
                                    <input hidden name="createdBy" id="createdBy" value="<%= req.session.result.username %>">

                                    

                                    
                                    
                                    
                                    

                                    
                                    <hr>
                                    <button class="btn btn-primary" type="submit">Add Student</button>
                                    <button id="cancelAddStudentBtn">Cancel</button>
                                    <p style="color: green; font-weight: bold;" id="message"></p>
                                </form>
                            </div>
                            
                              <a href="/salle/user/<%= req.session.result.username %>" type="button" class="btn btn-danger">back to Salle List</a>

                            <a href="/home" class="btn btn-info">Back home</a>
                            <div class="row" style="margin-top: 20px;">
                                <div class="col-sm">
                                  <div class="form-group">
                                    <label for="searchInput">Search:</label>
                                    <input type="text" id="searchInput" class="form-control" placeholder="Enter name or last name">
                                  </div>
                                </div>
                              </div>
                            <div class="row" style="margin-top: 20px;">
                                <div class="col-sm">
                                    <div class="table-wrap">
                                        <table id="datable_1" class="table table-hover w-100 display pb-30">
                                            <thead>
                                                <tr >
                                                    <th>CIN</th>
                                                    <th>Name</th>
                                                    <th>Last Name</th>
                                                    <th>Age</th>
                                                    <th>Level</th>
    
                                                    <th>Action</th>
                                                </tr>
                                            </thead>
                                            <tbody id="studentTable">
                                                <% for (const result of students) { %>
                                                <tr id="row_<%= result.cin.value %>">
                                                    <td style="font-weight: bold;"><%= result.cin.value %></td>
                                                    <td><%= result.name.value %></td>
                                                    <td><%= result.lastname.value %></td>
                                                    <td><%= result.age.value %></td>
                                                    <td><%= result.level.value %></td>
                                                    
                                                    <!-- <td><form method="post" action="/deleteStudent/<%= result.classe.value %>/<%= result.cin.value %>" class="inline">
                                                        <button type="submit" class="focus:outline-none text-white bg-red-700 hover:bg-red-800 focus:ring-4 focus:ring-red-300 font-medium rounded-lg text-sm px-5 py-2.5 mb-2 dark:bg-red-600 dark:hover:bg-red-700 dark:focus:ring-red-900">Delete</button>
                                                      </form></td> -->
                                                      <td><a href="#" style="color: red;" onclick="deleteStudent('<%= result.cin.value %>')">Delete</a></td>
                                                      
                                                    
                                                </tr>
                                                <% } %>
                                                
                                               
                                                
                                                
                                                
                                                
                                            </tbody>
                                            
                                        </table>
                                        
                                    </div>
                                </div>
                            </div>
                        </section>
                        
                        
                        
                    </div>
                </div>
                <script>
                    document.addEventListener("DOMContentLoaded", function() {
                    const searchInput = document.getElementById("searchInput");
                    const tableRows = document.querySelectorAll("#datable_1 tbody tr");

                    searchInput.addEventListener("input", function() {
                    const searchText = searchInput.value.toLowerCase();
                    tableRows.forEach(function(row) {
                    const name = row.querySelector("td:nth-child(1)").textContent.toLowerCase();
                    const lastName = row.querySelector("td:nth-child(2)").textContent.toLowerCase();
                     if (name.includes(searchText) || lastName.includes(searchText)) {
                      row.style.display = "table-row";
                       } else {
                       row.style.display = "none";
                       }
                     });
    });
  });
                 </script>
                 <script>
                  function fetchSalles(){
                                const user = localStorage.getItem("user");
                              console.log("this user is " + user);
                              fetch(`/salle/user2/${user}`)
                                .then((response) => response.json())
                                .then((data) => {
                                    const theSelect=document.getElementById("classe")
                                  
                        
                                  data.mySalles.forEach((sallee) => {
                                    const option = document.createElement("option");
                                    option.value=sallee.id_salle.value
                                    option.textContent=sallee.libelle_salle.value;
                                    theSelect.appendChild(option)
                                  });
                                })
                                .catch((error) => {
                                  console.log(error);
                                });
                               
                        
                            }
                  
                    function deleteStudent(cin) {
                                fetch(`/deleteStudent/${cin}`, {
                                 method: 'POST',
                                     })
                                     .then((response) => {
                                      if (response.ok) {

                                        const rowToDelete = document.getElementById(`row_${cin}`);
                                         if (rowToDelete) {
                                         rowToDelete.remove();
                                             }
                                           } else {

                                            console.error('Failed to delete student:', response);
                                              }
                                                 })
                                               .catch((error) => {
                                                console.error('Error occurred while deleting student:', error);
                                                  });
                                                }
                    document.addEventListener("DOMContentLoaded", function () {
                      fetchSalles()
                        const studentTable = document.getElementById('studentTable');
                        
                        function addStudentToTable(data) {
                        const newRow = document.createElement('tr');
                          newRow.innerHTML = `
                             <td style="font-weight: bold;">${data.cin}</td>
                             <td>${data.name}</td>
                             <td>${data.lastname}</td>
                             <td>${data.age}</td>
                             <td>${data.level}</td>
                    
                               <td>
                                 <a href="#" onclick="deleteStudent('${data.cin}')">Delete</a>
                                     </td>
                                         `;
                                 newRow.id = `row_${data.cin}`;
                                 studentTable.appendChild(newRow);
                                }
                                
                      document.getElementById("openAddStudentFormBtn").addEventListener("click", function () {
                        document.getElementById("addStudentFormContainer").style.display = "block"; // Show the form
                      });
                  
                      
                      document.getElementById("cancelAddStudentBtn").addEventListener("click", function () {
                        document.getElementById("addStudentFormContainer").style.display = "none"; // Hide the form
                      });
                  
                      
                      document.getElementById("addStudentForm").addEventListener("submit", function (event) {
                        event.preventDefault(); 
                        const formData = new FormData(event.target);
                        fetch("/saveStudent2", {
                          method: "POST",
                          body: formData,
                        })
                          .then((response) => {
                            
                            if (!response.ok) {
                              throw new Error("Something went wrong ");
                            }
                            return response.json()
                            
                          })
                          .then((data)=>{
                            if (data.message==="this cin already exists"){
                                document.getElementById("message2").textContent = data.message;
                            setTimeout(() => {
                                document.getElementById("message2").textContent = "";

                                
                            }, 2000);

                            }
                            if (data.message==="added student successfully"){
                                document.getElementById("message").textContent = data.message;
                                console.log("the data bro"+data.createdStudent)
                                addStudentToTable(data.createdStudent);

                            setTimeout(() => {
                                document.getElementById("message").textContent = "";
                                
                            }, 2000);

                            }
                            
                          })
                          
                          
                          .catch((error) => {
                            console.error("Error:", error);
                            document.getElementById("message2").textContent = "Error: " + error.message; 
                            setTimeout(() => {
                                document.getElementById("message2").textContent = ""; 
                                
                            }, 2000);
                          });
                  
                        // Hide the form after successful form submission
                        
                      });
                    });
                  </script>
                
                <!-- /Row -->

            </div>
            <!-- /Container -->

            

        
        <!-- /Main Content -->

    
    <!-- /HK Wrapper -->

    

</body>

</html>